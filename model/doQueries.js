const syncSql = require('mysql');

const config = syncSql.createConnection({
    host: "127.0.0.1",
    user: "root",
    password: "adjkadh34@fS",
    database: "tennisdb"
});
config.connect(function(err) {
    if ( err ) throw err
    console.log("Connected to database as " + config.threadId)
  }); 

function login(userName, password) {
    let loginQuery =
        "SELECT user_name FROM user WHERE user_name = '" + userName +"' and password = '" + password+"'";
    try {
        config.query(loginQuery, function (err, results, fields) {
            if (err) throw err;
            if (results[0] === undefined) return null;
            let result_username = results[0].username;
            if (userName === result_username) return results[0];
            return null;
        })
    } catch {
        console.log("catch");
        return null;
    }
}

function signUp(
    userName,
    password,
    country,
    age,
    favorite_player,
    phone_number
) {
    let signUpQuery =
        "INSERT INTO user(user_name, password, country, age, favorite_player, phone_number)" +
        "VALUES (" +
        userName +
        "," +
        password +
        "," +
        country +
        "," +
        age +
        "," +
        favorite_player +
        "," +
        phone_number +
        ")";
    try {
        config.query(signUpQuery);
    } catch (error) {
        // check if user already in use
    
        if (error.code === "ER_DUP_ENTRY") return "Username already is use!";
        return false;
    }
    return "You are signed up!";
}

//input user name output user id


//Return the games
function getGames(player1, player2) {
    let getGames =
        "SELECT * From Matches WHERE (player_1 = ? player1 AND player_2 = ?) OR (player_1 = ? AND player_2 = ?) LIMIT 10";

    var table = [];
    var result = config.query(getGames, [player1, player2]);
    if (result[0] === undefined) return false;
    Object.keys(result).forEach(function (key) {
        table.push(Object.values(result[key]));
    });
    return table;
}

function getComments(gameID) {
    let getGames = "SELECT user_id,comment From Comments WHERE match_id = ?";
    var table = [];
    var result = config.query(getGames, [gameID]);
    if (result[0] === undefined) return false;
    Object.keys(result).forEach(function (key) {
        table.push(Object.values(result[key]));
    });
    return table;
}

function insertComment(userName, userId, comment) {
    let insertComment =
        "INSERT INTO Comment(match_id, user_id, comment)" +
        "VALUES (" +
        userName +
        "," +
        userId +
        "," +
        comment +
        ")";
    try {
        config.query(insertComment);
        return "Succeeded";
    } catch (error) {
        if (error.code === "ER_DUP_ENTRY") {
            return "not succeed";
        }
    }
}

//need to check how to write
function getFavoritePlayer(username, favorite) {
    let playerName = "SELECT player_name FROM User where user_name =?";
    var table = [];
    var result = config.query(getGames, [username]);
    if (result[0] === undefined) return false;

    let favoritrPlayer =
        "SELECT * FROM player where player_name in (SELECT player_name FROM User where user_name =?)";
    var result2 = config.query(getGames, [playerName]);

    return result2;
}

//Return the games
function getCommonUsers(first, last, height, hand, nationality) {
    let getCommonUsers =
        "SELECT user_id, phone_number FROM User WHERE player_id = (SELECT player_id FROM Player WHERE first_name = ? AND last_name = ? AND hight = ? AND nationallity = ? )";

    var table = [];
    var result = config.query(getCommonUsers, [
        first,
        last,
        height,
        hand,
        nationality,
    ]);
    if (result[0] === undefined) return false;
    Object.keys(result).forEach(function (key) {
        table.push(Object.values(result[key]));
    });
    return table;
}

function getTopPlayers(playerID) {
    let getTopPlayer =
        "SELECT user_id, phone_number FROM User WHERE player_id = (SELECT player_id FROM Player WHERE first_name = ? AND last_name = ? AND hight = ? AND nationallity = ? )";

    var table = [];
    var result = config.query(getTopPlayer);
    if (result[0] === undefined) return false;
    Object.keys(result).forEach(function (key) {
        table.push(Object.values(result[key]));
    });
    return table;
}



function getTopCountries(first, last, height, hand, nationality) {
    let getTopCountries =
        "SELECT user_id, phone_number FROM User WHERE player_id = (SELECT player_id FROM Player WHERE first_name = ? AND last_name = ? AND hight = ? AND nationallity = ? )";

    var table = [];
    var result = config.query(getTopCountries);
    if (result[0] === undefined) return false;
    Object.keys(result).forEach(function (key) {
        table.push(Object.values(result[key]));
    });
    return table;
}


module.exports.login = login;
module.exports.signUp = signUp;

module.exports.getGames = getGames;
module.exports.getComments = getComments;
module.exports.insertComment = insertComment;

module.exports.getFavoritePlayer = getFavoritePlayer;
module.exports.getCommonUsers = getCommonUsers;
module.exports.getTopPlayers = getTopPlayers;
module.exports.getTopCountries = getTopCountries;


